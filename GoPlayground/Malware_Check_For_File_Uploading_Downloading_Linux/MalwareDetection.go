package main

import (
	"fmt"
	"os/exec"
	"regexp"
	"strconv"
)

func main() {

	app := "clamscan"
	fileName := "test.html" // Clean file.
	//fileName = "eqig.ex_"	// Infected File.
	execResponse := exec.Command(app, fileName)

	pipe, pipeErr := execResponse.StdoutPipe()
	if pipeErr != nil {
		fmt.Println("Error while creating pipe for grep.")
	}

	defer pipe.Close()

	grep := exec.Command("grep", "Infected files:")
	grep.Stdin = pipe

	startError := execResponse.Start()
	if startError != nil {
		fmt.Println("Error while starting clamscan process.")
	}

	grepResponse, grepError := grep.Output()
	if grepError != nil {
		fmt.Println("Error while fetching the standard output.", grepError)
	}
	fmt.Println("Virus Scan Report:", string(grepResponse))

	scanReport := string(grepResponse)

	re := regexp.MustCompile(`[-]?\d[\d,]*[\.]?[\d{2}]*`)

	regexpResponse := re.FindString(scanReport)

	infectedFileCount, strAtoiErr := strconv.Atoi(regexpResponse)

	if strAtoiErr != nil {
		fmt.Println("Error while convertring string to int:", strAtoiErr)
	}
	if infectedFileCount > 0 {
		fmt.Println("Infected file found.")
	} else {
		fmt.Println("Ready to download/upload file.")
	}
	fmt.Println("Program ends.")
}
